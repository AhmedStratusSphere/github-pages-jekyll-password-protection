

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> r_it_ue_set_cc_on_stcc.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Modules</h3><ul><li><a href="module-r_it_ue_set_cc_on_stcc.html">r_it_ue_set_cc_on_stcc</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>r_it_ue_set_cc_on_stcc.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 *
 * @fileoverview This script sets the cost code on the line items of the journal entry and credit card charge based on the standard cost code and project.
 *
 *@NApiVersion 2.1
 *@NScriptType UserEventScript
 *
 * @Title R-IT Set Cost Code on Standard Cost Code
 *
 * @module r_it_ue_set_cc_on_stcc
 * @requires N/log
 * @requires N/search
 * @requires N/record
 * @requires N/runtime
 *
 */
define(['N/log', 'N/search', 'N/record', 'N/runtime'],
    function (log, search, record, runtime) {

        /**
         * Executes when a record is submitted.
         *
         * @function afterSubmit
         * @param context
         * @returns {void}
         */
        function afterSubmit(context) {
            try {

                let projects = []

                /**
                 * @name newRecord
                 * @type {Object}
                 * @description Get the new record
                 * @example
                 * var newRec = context.newRecord;
                 *
                 */
                var newRec = context.newRecord;

                /**
                 * @name newRec
                 * @type {Record}
                 * @description Load the record
                 */
                newRec = record.load({
                    type: newRec.type,
                    id: newRec.id
                });


                if (newRec.type == 'journalentry') {

                    /**
                     * @name totalLines
                     * @type {number}
                     * @description Get the total number of lines
                     * @example
                     * var totalLines = newRec.getLineCount({   sublistId: 'line' });
                     */
                    let totalLines = newRec.getLineCount({
                        sublistId: 'line'
                    });

                    let standardCCs = [];
                    for (var i = 0; i &lt; totalLines; i++) {
                        let proj = newRec.getSublistValue({
                            sublistId: 'line',
                            fieldId: 'entity',
                            line: i
                        });
                        if (proj) {
                            if (projects.indexOf(proj) == -1) {
                                projects.push(proj);
                            }
                        }

                        let stCostCode = newRec.getSublistValue({
                            fieldId: 'custcol_r_it_std_cost_code',
                            sublistId: 'line',
                            line: i
                        });
                        if (stCostCode) {
                            if (standardCCs.indexOf(stCostCode) == -1) {
                                standardCCs.push(stCostCode);
                            }
                        }
                    }
                    if (projects.length == 0 || standardCCs.length == 0) {
                        return;
                    }

                    /**
                     * @name costCodes
                     * @type {Object}
                     * @description Get the cost codes
                     * @example
                     * let costCodes = getCostCodes(projects);
                     *
                     */
                    let costCodes = getCostCodes(projects);

                    /**
                     * @name standardIds
                     * @type {Object}
                     * @description Get the standard cost code IDs
                     * @example
                     * let standardIds = getStandardCostCodeId(standardCCs);
                     *
                     */
                    let standardIds = getStandardCostCodeId(standardCCs);

                    log.debug('cost codes ', costCodes);
                    for (var i = 0; i &lt; totalLines; i++) {

                        let stCostCode = newRec.getSublistValue({
                            fieldId: 'custcol_r_it_std_cost_code',
                            sublistId: 'line',
                            line: i
                        });

                        stCostCode = standardIds[stCostCode];
                        let proj = newRec.getSublistValue({
                            fieldId: 'entity',
                            sublistId: 'line',
                            line: i
                        });
                        log.debug('st cost code ', stCostCode);
                        log.debug('proj', proj);
                        if (stCostCode &amp;&amp; proj) {

                            /**
                             * @name costCode
                             * @type {string}
                             * @description Get the cost code based on the standard cost code and project
                             * @example
                             * let costCode = costCodes[stCostCode + '_' + proj];
                             */
                            let costCode = costCodes[stCostCode + '_' + proj];
                            if (costCode) {
                                let costType = newRec.getSublistValue({
                                    sublistId: 'line',
                                    fieldId: 'custcol_hrc_cost_type',
                                    line: i

                                });
                                newRec.setSublistValue({
                                    sublistId: 'line',
                                    fieldId: 'custcol_hrc_cost_code_line',
                                    line: i,
                                    value: costCode
                                });
                                if (costType) {
                                    newRec.setSublistValue({
                                        sublistId: 'line',
                                        fieldId: 'custcol_hrc_cost_type',
                                        line: i,
                                        value: costType
                                    });
                                }
                            }
                        }

                    }
                }
                if (newRec.type == 'creditcardcharge') {
                    let sublists = ['item', 'expense'];
                    for (let j = 0; j &lt; sublists.length; j++) {

                        let totalLines = newRec.getLineCount({
                            sublistId: sublists[j]
                        });
                        let standardCCs = [];
                        for (var i = 0; i &lt; totalLines; i++) {
                            let proj = newRec.getValue({
                                fieldId: 'custbody_hrc_pci_project'
                            })
                            if (proj) {
                                if (projects.indexOf(proj) == -1) {
                                    projects.push(proj);
                                }
                            }
                            let stCostCode = newRec.getSublistValue({
                                fieldId: 'custcol_r_it_std_cost_code',
                                sublistId: sublists[j],
                                line: i
                            });
                            if (stCostCode) {
                                if (standardCCs.indexOf(stCostCode) == -1) {
                                    standardCCs.push(stCostCode);
                                }
                            }
                        }
                        if (projects.length == 0 || standardCCs.length == 0) {
                            continue;
                        }

                        let costCodes = getCostCodes(projects);
                        let standardIds = getStandardCostCodeId(standardCCs);
                        log.debug('cost codes ', costCodes);
                        for (var i = 0; i &lt; totalLines; i++) {
                            let stCostCode = newRec.getSublistValue({
                                fieldId: 'custcol_r_it_std_cost_code',
                                sublistId: sublists[j],
                                line: i
                            });
                            stCostCode = standardIds[stCostCode];
                            let proj = newRec.getValue({
                                fieldId: 'custbody_hrc_pci_project'
                            })
                            log.debug('st cost code ', stCostCode);
                            log.debug('proj', proj);
                            if (stCostCode &amp;&amp; proj) {
                                let costCode = costCodes[stCostCode + '_' + proj];
                                if (costCode) {
                                    let costType = newRec.getSublistValue({
                                        sublistId: sublists[j],
                                        fieldId: 'custcol_hrc_cost_type',
                                        line: i

                                    });
                                    newRec.setSublistValue({
                                        sublistId: sublists[j],
                                        fieldId: 'custcol_hrc_cost_code_',
                                        line: i,
                                        value: costCode
                                    });
                                    if (costType) {
                                        newRec.setSublistValue({
                                            sublistId: sublists[j],
                                            fieldId: 'custcol_hrc_cost_type',
                                            line: i,
                                            value: costType
                                        });
                                    }
                                }

                            }

                        }

                    }

                }
                newRec.save({
                    ignoreMandatoryFields: true
                });
            } catch (ex) {
                log.error('ERROR ' + ex.message, JSON.stringify(ex));
            }
        }



        /**
         * Retrieves the internal IDs of the standard cost codes.
         *
         *
         * @function getStandardCostCodeId
         *
         * @param {Array} standardCCs - The array of standard cost codes.
         * @returns {Object} - The object containing the internal IDs of the standard cost codes.
         *
         * @example &lt;caption>Example usage of getStandardCostCodeId function.&lt;/caption>
         * getStandardCostCodeId(standardCCs);
         *
         */
        function getStandardCostCodeId(standardCCs) {
            log.debug('standard ', standardCCs);
            let mySearch = search.create({
                type: 'customrecord_r_it_list_code',
                title: 'Cost Code Search',
                columns: ['name'], // Update : change "custrecord_r_it_std_list_cost_code_id" to "name"
                filters: [{
                    name: 'internalid',
                    operator: 'anyof',
                    values: standardCCs
                }]
            });
            let obj = {};
            mySearch.run().each(function (result) {
                obj[result.id] = result.getValue('name') // Update : change "custrecord_r_it_std_list_cost_code_id" to "name"
                return true;
            });
            return obj;
        }

        /**
         *
         * Retrieves the cost codes.
         *
         * @function getCostCodes
         * @param projects
         * @returns {Object} - The object containing the cost codes.
         *
         * @example &lt;caption>Example usage of getCostCodes function.&lt;/caption>
         * getCostCodes(projects);
         *
         */

        function getCostCodes(projects) {
            let mySearch = search.create({
                type: 'customrecord_hrc_pci_costcode',
                title: 'Cost Code Search',
                columns: ['name', 'custrecord_hrc_pci_projectlink2'], // Update : change "custrecord_hrc_pci_standardcostcodeid" to "name"
                filters: [{
                    name: 'custrecord_hrc_pci_projectlink2',
                    operator: 'anyof',
                    values: projects
                }]
            });
            let obj = {};
            mySearch.run().each(function (result) {
                let stCostCode = result.getValue('name'); //Update : change "custrecord_hrc_pci_standardcostcodeid" to "name"
                let proj = result.getValue('custrecord_hrc_pci_projectlink2');
                if (stCostCode &amp;&amp; proj) {
                    obj[stCostCode + '_' + proj] = result.id;
                }
                return true;
            });
            return obj;
        }

        return {
            afterSubmit: afterSubmit
        };
    });
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.3</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
